/* ************************************************************************** */
/*                                                                            */
/*                                                        :::      ::::::::   */
/*   ft_strrchr.c                                       :+:      :+:    :+:   */
/*                                                    +:+ +:+         +:+     */
/*   By: abeauvoi <marvin@42.fr>                    +#+  +:+       +#+        */
/*                                                +#+#+#+#+#+   +#+           */
/*   Created: 2017/04/14 19:10:08 by abeauvoi          #+#    #+#             */
/*   Updated: 2018/12/02 02:08:51 by mac              ###   ########.fr       */
/*                                                                            */
/* ************************************************************************** */

#include "libft.h"

#define	LWORD 0
#define	END_MASK 1
#define	LAST_BYTE 2 
#define	GOAL_MATCH 3

char					*ft_strrchr(const char *s, int c)
{
	const uint64_t const 	*last_word = (const uint64_t *)((uintptr_t)s & -8);
	const uint64_t			*p;
	uint64_t				v[4];
	char 					*res;
	const uint64_t 			goal = 0X0101010101010101ULL * (uint8_t)c;

	v[LAST_BYTE] = (uint64_t)(s + ft_strlen(s) - 1);
	p = (const uint64_t *)(v[LAST_BYTE] & -8);
	v[END_MASK] = (0XFFFFFFFFFFFFFF00ULL &
			(-256ULL << ((p - v[LAST_BYTE]) << 3)));
	v[LWORD] = (*p | v[END_MASK]) ^ (goal & v[END_MASK]);
	while ((v[GOAL_MATCH] = ft_haschar(v[LWORD], goal)) == 0)
	{
		if (p == last_word)
			return (NULL);
		v[LWORD] = *--p;
	}
	res = (char *)p + (__builtin_ctzll(v[GOAL_MATCH]) >> 3);
	return (res >= s ? res : NULL);
}
